<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holy Family Church Hall Hire Agreement</title>
    <!-- Add the logo image first to preload -->
    <link rel="preload" as="image" href="CAOS.png">
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.6/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 30px;
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }
        
        #church-logo {
            max-width: 300px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        .header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .header h2 {
            color: var(--secondary-color);
            margin-bottom: 15px;
        }
        
        .info-box {
            background-color: #e8f4fd;
            border-left: 4px solid var(--secondary-color);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        
        .progress-container {
            margin: 30px 0;
            background-color: var(--light-color);
            border-radius: 10px;
            padding: 20px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #ddd;
            border-radius: 5px;
            margin: 10px 0 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--secondary-color);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .section.completed {
            border-left-color: var(--success-color);
            background-color: #e8f5e9;
        }
        
        .section h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .section-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #eee;
            margin-bottom: 15px;
        }
        
        .section-content p {
            margin-bottom: 10px;
        }
        
        .section-content .sub-clause {
            margin-left: 20px;
            margin-bottom: 8px;
        }
        
        .section-content .sub-sub-clause {
            margin-left: 40px;
            margin-bottom: 6px;
        }
        
        .read-confirm {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-container label {
            font-weight: bold;
            cursor: pointer;
        }
        
        .section-number {
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .user-details-form {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 2px solid var(--secondary-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .btn {
            padding: 12px 25px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .btn-container {
            text-align: center;
            margin-top: 30px;
        }
        
        .notice {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .warning {
            background-color: #fde8e8;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        /* Signature Canvas Styles */
        #signatureCanvas {
            cursor: crosshair;
            touch-action: none;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            width: 100%;
            height: 150px;
        }
        
        .signature-status {
            margin-top: 5px;
            font-size: 0.9em;
        }
        
        .signature-status.signed {
            color: var(--success-color);
        }
        
        .signature-status.unsigned {
            color: var(--warning-color);
        }
        
        .character-counter {
            text-align: right;
            font-size: 0.9em;
            margin-top: 5px;
            color: #666;
        }
        
        .character-counter.near-limit {
            color: var(--warning-color);
        }
        
        .character-counter.at-limit {
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .signature-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .section-content {
                max-height: 200px;
            }
            
            #signatureCanvas {
                height: 100px;
            }
            
            .signature-buttons {
                flex-direction: column;
            }
            
            .signature-buttons button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img id="church-logo" src="CAOS.png" 
                     alt="Holy Family Church Logo" onerror="handleImageError()">
            </div>
            <h1>Holy Family Church Hall Hire Agreement</h1>
            <h2>PARISH PROPERTY AT HOLY FAMILY CATHOLIC CHURCH, PARKWOOD, MAIDSTONE</h2>
            <p>Please read each section carefully and confirm you've read them before proceeding</p>
        </div>
        
        <!-- Rest of your HTML content remains the same -->
        <!-- ... (all the sections and form content) ... -->
        
    </div>

<script>
    // Initialize jsPDF
    const { jsPDF } = window.jspdf;
    
    // Track checked sections
    let checkedSections = new Set();
    const totalSections = 17;
    
    // Signature Pad variables
    let signaturePad = null;
    let isSignatureSigned = false;
    let signatureConfirmed = false;
    
    // Function to handle image loading errors
    function handleImageError() {
        console.log('Local image failed to load, using fallback text');
        const logoContainer = document.querySelector('.logo-container');
        if (logoContainer) {
            logoContainer.innerHTML = '<h1>Holy Family Church</h1>';
        }
    }
    
    // Function to load image for PDF with fallback
    function loadImageForPDF(callback) {
        const img = document.getElementById('church-logo');
        
        // Check if image is already loaded
        if (img && img.complete && img.naturalHeight !== 0) {
            callback(img);
            return;
        }
        
        // Create a new image to ensure it loads
        const pdfImg = new Image();
        pdfImg.crossOrigin = 'Anonymous'; // For CORS if needed
        
        // Try local file first
        pdfImg.src = 'CAOS.png';
        
        pdfImg.onload = function() {
            console.log('Local image loaded successfully for PDF');
            callback(pdfImg);
        };
        
        pdfImg.onerror = function() {
            console.log('Local image failed to load, PDF will continue without logo');
            callback(null);
        };
    }
    
    // Function to extract all sections with structure
    function extractAllSections() {
        const sections = [];
        document.querySelectorAll('.section').forEach((section, index) => {
            const sectionNumber = section.querySelector('.section-number')?.textContent || `Section ${index + 1}`;
            const sectionTitle = section.querySelector('h2')?.textContent.replace(sectionNumber, '').trim() || '';
            
            // Extract all paragraphs including those in sub-clauses
            const sectionContent = [];
            const sectionContentDiv = section.querySelector('.section-content');
            
            if (sectionContentDiv) {
                // Get all text nodes and paragraphs
                const paragraphs = sectionContentDiv.querySelectorAll('p');
                
                paragraphs.forEach(p => {
                    const text = p.textContent.trim();
                    if (text) {
                        sectionContent.push({
                            text: text,
                            // We're not using indent anymore since we're using full width
                            indent: 0
                        });
                    }
                });
                
                // Also get any text that might be directly in divs but not in paragraphs
                const subClauses = sectionContentDiv.querySelectorAll('.sub-clause, .sub-sub-clause');
                subClauses.forEach(subClause => {
                    const subParagraphs = subClause.querySelectorAll('p');
                    if (subParagraphs.length === 0) {
                        // If the sub-clause itself has direct text
                        const text = subClause.textContent.trim();
                        if (text) {
                            sectionContent.push({
                                text: text,
                                indent: 0
                            });
                        }
                    }
                });
            }
            
            sections.push({
                number: sectionNumber,
                title: sectionTitle,
                content: sectionContent
            });
        });
        return sections;
    }
    
    // Function to format clauses for PDF (simplified for full width)
    function formatClausesForPDF(clauses, maxWidth) {
        const formattedLines = [];
        
        clauses.forEach(clause => {
            if (clause.text.trim()) {
                // Just return the text without indentation
                formattedLines.push({
                    text: clause.text.trim(),
                    indent: 0  // No indentation
                });
                // Add an empty line after each clause
                formattedLines.push({
                    text: '',
                    indent: 0
                });
            }
        });
        
        return formattedLines;
    }
    
    // Update progress
    function updateProgress() {
        const percent = (checkedSections.size / totalSections) * 100;
        document.getElementById('progress-percent').textContent = Math.round(percent) + '%';
        document.getElementById('sections-read').textContent = checkedSections.size;
        document.getElementById('progress-fill').style.width = percent + '%';
        
        checkedSections.forEach(section => {
            document.getElementById(`section-${section}`).classList.add('completed');
        });
        
        const proceedBtn = document.getElementById('proceedBtn');
        proceedBtn.disabled = checkedSections.size !== totalSections;
    }
    
    // Handle checkbox changes
    document.querySelectorAll('.section-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const section = this.getAttribute('data-section');
            if (this.checked) {
                checkedSections.add(section);
                document.getElementById(`section-${section}`).classList.add('completed');
            } else {
                checkedSections.delete(section);
                document.getElementById(`section-${section}`).classList.remove('completed');
            }
            updateProgress();
        });
    });
    
    // Proceed to details form
    document.getElementById('proceedBtn').addEventListener('click', function() {
        document.getElementById('userDetailsForm').style.display = 'block';
        this.style.display = 'none';
        
        // Initialize signature pad after a short delay
        setTimeout(() => {
            initSignaturePad();
        }, 500);
    });
    
    // Initialize Signature Pad
    function initSignaturePad() {
        const canvas = document.getElementById('signatureCanvas');
        const signatureDataInput = document.getElementById('signatureData');
        
        if (!canvas) {
            console.error('Canvas element not found!');
            return;
        }
        
        // Set canvas dimensions
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        
        // Clear any existing signature pad
        if (signaturePad) {
            signaturePad.off();
            signaturePad.clear();
        }
        
        // Initialize Signature Pad
        try {
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: '#f9f9f9',
                penColor: 'rgb(0, 0, 0)',
                velocityFilterWeight: 0.7,
                minWidth: 0.5,
                maxWidth: 2.5,
                minPointDistance: 3
            });
        } catch (error) {
            console.error('Error initializing Signature Pad:', error);
            return;
        }
        
        // Clear signature button
        document.getElementById('clearSignature').addEventListener('click', function() {
            signaturePad.clear();
            signatureDataInput.value = '';
            signatureConfirmed = false;
            updateSignatureStatus();
        });
        
        // Confirm Signature button
        document.getElementById('confirmSignature').addEventListener('click', function() {
            if (!signaturePad.isEmpty()) {
                signatureDataInput.value = signaturePad.toDataURL();
                signatureConfirmed = true;
                updateSignatureStatus();
                alert('Signature confirmed successfully!');
            } else {
                alert('Please sign first before confirming.');
            }
        });
        
        // Update signature status on end
        signaturePad.onEnd = function() {
            updateSignatureStatus();
        };
        
        // Initial status update
        updateSignatureStatus();
    }
    
    function updateSignatureStatus() {
        const signatureDataInput = document.getElementById('signatureData');
        const statusElement = document.getElementById('signatureStatus');
        
        if (!signaturePad) {
            isSignatureSigned = false;
            if (statusElement) {
                statusElement.textContent = '✗ Signature system not initialized';
                statusElement.className = 'signature-status unsigned';
            }
            return;
        }
        
        isSignatureSigned = !signaturePad.isEmpty();
        
        if (statusElement) {
            if (isSignatureSigned && signatureConfirmed) {
                statusElement.textContent = '✓ Signature confirmed and saved';
                statusElement.className = 'signature-status signed';
            } else if (isSignatureSigned && !signatureConfirmed) {
                statusElement.textContent = '✗ Signature drawn but not confirmed - click "Confirm Signature"';
                statusElement.className = 'signature-status unsigned';
            } else {
                statusElement.textContent = '✗ Signature required';
                statusElement.className = 'signature-status unsigned';
                signatureDataInput.value = '';
            }
        }
    }
    
    // Character counter for purpose text box
    document.getElementById('purpose').addEventListener('input', function() {
        const counter = document.getElementById('purpose-counter');
        const length = this.value.length;
        const maxLength = 300;
        
        counter.textContent = `${length}/${maxLength}`;
        
        // Update counter style based on remaining characters
        counter.classList.remove('near-limit', 'at-limit');
        if (length > maxLength * 0.9) { // 90% of limit
            counter.classList.add('near-limit');
        }
        if (length >= maxLength) {
            counter.classList.add('at-limit');
        }
    });
    
    // Generate PDF function with all requested features
    function generatePDF(formData) {
        try {
            // Check signature data
            if (!formData.signatureData || formData.signatureData.trim() === '') {
                throw new Error('No signature data provided. Please sign and confirm your signature.');
            }
            
            if (!signatureConfirmed) {
                throw new Error('Signature not confirmed. Please click "Confirm Signature" button.');
            }
            
            console.log('Generating PDF...');
            
            // Create new PDF document
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let yPos = 20;
            
            // Load and add logo to PDF
            loadImageForPDF(function(logoImg) {
                // Continue PDF generation whether or not image loaded
                if (logoImg) {
                    try {
                        // Calculate dimensions for PDF
                        const imgWidth = 40;
                        const imgHeight = (logoImg.height * imgWidth) / logoImg.width;
                        
                        // Add logo to PDF (centered)
                        doc.addImage(logoImg, 'PNG', (pageWidth - imgWidth) / 2, yPos, imgWidth, imgHeight);
                        yPos += imgHeight + 15;
                        console.log('Logo added to PDF successfully');
                    } catch (error) {
                        console.log('Could not add image to PDF:', error.message);
                        // Continue without logo
                    }
                }
                
                // Continue with PDF generation
                continuePDFGeneration(doc, pageWidth, pageHeight, yPos, formData);
            });
            
        } catch (error) {
            console.error('Error generating PDF:', error.message);
            alert('Error generating PDF: ' + error.message);
        }
    }
    
    // Function to continue PDF generation after image is loaded (or not)
    function continuePDFGeneration(doc, pageWidth, pageHeight, yPos, formData) {
        // Add header
        doc.setFontSize(20);
        doc.setTextColor(44, 62, 80);
        doc.text('HOLY FAMILY CATHOLIC CHURCH HALL HIRE AGREEMENT', pageWidth / 2, yPos, { align: 'center' });
        yPos += 15;
        
        doc.setFontSize(12);
        doc.setTextColor(52, 152, 219);
        doc.text('PARISH PROPERTY AT HOLY FAMILY CATHOLIC CHURCH, PARKWOOD, MAIDSTONE', pageWidth / 2, yPos, { align: 'center' });
        yPos += 20;
        
        // Add line
        doc.setDrawColor(44, 62, 80);
        doc.setLineWidth(0.5);
        doc.line(20, yPos, pageWidth - 20, yPos);
        yPos += 10;
        
        // Information for Hirers
        doc.setFontSize(14);
        doc.setTextColor(44, 62, 80);
        doc.text('INFORMATION FOR HIRERS', 20, yPos);
        yPos += 10;
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        
        const infoText = [
            "Parish property is primarily for use in conjunction with the Church and its services, including baptisms,",
            "weddings, and funerals. It is available for use by groups associated with the Parish or for other purposes",
            "at the discretion of the Parish Priest.",
            "",
            "The Property is owned by the Roman Catholic Archdiocese of Southwark CIO and can only be hired on the",
            "basis that the use must conform and be consistent with the objects of the Charity and that it will not be",
            "used for any purpose which is contrary to the teachings of the Catholic Church or which could cause offence.",
            "At all times, the Catholic nature of the Building is to be respected.",
            "",
            "Hire Fees: The hire fees are as set out in the Hire Agreement. For private bookings, a deposit of £150",
            "is required at the time of booking. The deposit will be returned in full within two weeks after use of",
            "the Hall. If additional cleaning of the Hall is required £100 will be deducted from the deposit.",
            "",
            "Payment: Full payment of the hire fee is due 28 days before the date of hire, or immediately upon",
            "signing the Hire Agreement if the hire period is less than 28 days from the booking."
        ];
        
        infoText.forEach(line => {
            if (yPos > pageHeight - 20) {
                doc.addPage();
                yPos = 20;
            }
            doc.text(line, 20, yPos);
            yPos += 6;
        });
        
        yPos += 10;
        
        // Add hirer details section in two-column format
        doc.setFontSize(14);
        doc.setTextColor(44, 62, 80);
        doc.text('HIRER DETAILS', 20, yPos);
        yPos += 10;
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        
        // Two-column layout
        const columnWidth = (pageWidth - 60) / 2; // 60 = left margin + middle gap + right margin
        const leftColumnX = 20;
        const rightColumnX = leftColumnX + columnWidth + 20;
        
        // Left column details
        doc.text(`Full Name: ${formData.fullName}`, leftColumnX, yPos);
        doc.text(`Email: ${formData.email}`, leftColumnX, yPos + 7);
        doc.text(`Address: ${formData.address}`, leftColumnX, yPos + 14);
        doc.text(`Hire Date: ${formData.hireDate}`, leftColumnX, yPos + 21);
        
        // Right column details
        doc.text(`Organization: ${formData.organization || 'N/A'}`, rightColumnX, yPos);
        doc.text(`Phone: ${formData.phone}`, rightColumnX, yPos + 7);
        doc.text(`Postcode: ${formData.postcode}`, rightColumnX, yPos + 14);
        doc.text(`Hire Time: ${formData.hireTimeFrom} to ${formData.hireTimeTo}`, rightColumnX, yPos + 21);
        
        yPos += 28;
        
        // Purpose (spans both columns)
        const purposeText = `Purpose: ${formData.purpose}`;
        const purposeLines = doc.splitTextToSize(purposeText, pageWidth - 40);
        purposeLines.forEach(line => {
            if (yPos > pageHeight - 20) {
                doc.addPage();
                yPos = 20;
            }
            doc.text(line, 20, yPos);
            yPos += 7;
        });
        
        // Attendees (spans both columns)
        doc.text(`Estimated Attendees: ${formData.attendees}`, 20, yPos);
        yPos += 10;
        
        // Add line separator
        doc.setDrawColor(44, 62, 80);
        doc.setLineWidth(0.5);
        doc.line(20, yPos, pageWidth - 20, yPos);
        yPos += 15;
        
        // Extract and add all sections with proper clause formatting
        const sections = extractAllSections();
        
        doc.setFontSize(14);
        doc.setTextColor(44, 62, 80);
        doc.text('CONDITIONS OF HIRE', 20, yPos);
        yPos += 15;
        
        // Add each section to PDF with proper clause formatting
        sections.forEach((section, index) => {
            if (yPos > pageHeight - 30) {
                doc.addPage();
                yPos = 20;
            }
            
            // Add section header
            doc.setFontSize(12);
            doc.setTextColor(44, 62, 80);
            const sectionTitle = `${section.number} ${section.title}`;
            doc.text(sectionTitle, 20, yPos);
            yPos += 8;
            
            // Add section content with clause formatting
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            // Format each clause to appear on a new line with full width
            const maxLineWidth = pageWidth - 40; // 20px margin on each side
            
            section.content.forEach(clause => {
                if (yPos > pageHeight - 20) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Clean and process the clause text
                let clauseText = clause.text.trim();
                
                // Ensure each clause starts on a new line
                if (clauseText) {
                    // Split long clauses into multiple lines
                    const lines = doc.splitTextToSize(clauseText, maxLineWidth);
                    
                    lines.forEach(line => {
                        if (yPos > pageHeight - 20) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        doc.text(line, 20, yPos);
                        yPos += 7;
                    });
                    
                    // Add a small gap after each clause
                    yPos += 3;
                } else {
                    // Empty line for spacing between major sections
                    yPos += 7;
                }
            });
            
            // Add more space between sections
            yPos += 10;
            
            // Add a page break after every 3 sections for better readability
            if ((index + 1) % 3 === 0 && index < sections.length - 1) {
                doc.addPage();
                yPos = 20;
            }
        });
        
        // Add signature page
        doc.addPage();
        yPos = 40;
        
        doc.setFontSize(16);
        doc.setTextColor(44, 62, 80);
        doc.text('DECLARATION AND SIGNATURE', pageWidth / 2, yPos, { align: 'center' });
        yPos += 20;
        
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        
        const declarationLines = [
            "I request the hire of the Premises on the date(s) and times and for the purpose set out above.",
            "",
            "Declaration on behalf of the Hirer: I have read and agree to observe and perform the provisions of this",
            "Hire Agreement, including the terms and conditions set out in the 'Conditions of Hire'. I am over 18",
            "years of age and duly authorised to enter into this Agreement on behalf of the Hirer.",
            "",
            "The Parish Priest permits the Hirer to use the Premises as set out above subject to the terms and",
            "conditions contained in this Agreement. The Hire Agreement will not be binding until accepted and",
            "signed by the Parish Priest. The Parish Priest may decline the request to hire the Premises at any",
            "time at his sole discretion."
        ];
        
        declarationLines.forEach(line => {
            doc.text(line, 20, yPos);
            yPos += 8;
        });
        
        yPos += 20;
        
        // Add signature if available
        if (formData.signatureData && formData.signatureData.startsWith('data:image')) {
            try {
                doc.text("Digital Signature of Hirer:", 20, yPos);
                yPos += 8;
                
                // Calculate signature dimensions
                const signatureWidth = 80;
                const signatureHeight = 30;
                doc.addImage(formData.signatureData, 'PNG', 20, yPos, signatureWidth, signatureHeight);
                yPos += signatureHeight + 10;
                
                doc.text(`Signed by: ${formData.fullName}`, 20, yPos);
                yPos += 8;
                doc.text(`Date: ${new Date().toLocaleDateString('en-GB')}`, 20, yPos);
                yPos += 8;
                doc.text(`Time: ${new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`, 20, yPos);
                
                console.log('Signature added to PDF successfully');
            } catch (e) {
                console.log("Error adding signature image:", e.message);
                doc.text("Signed (Hirer): ___________________________", 20, yPos);
                yPos += 8;
                doc.text("Date: ___________________________", 20, yPos);
            }
        }
        
        yPos += 20;
        
        // Add space for Parish Priest signature
        doc.text("For and on behalf of Holy Family Catholic Church:", 20, yPos);
        yPos += 15;
        doc.text("Signed (Parish Priest/Authorised Representative): ___________________________", 20, yPos);
        yPos += 8;
        doc.text("Date: ___________________________", 20, yPos);
        yPos += 8;
        doc.text("Name: ___________________________", 20, yPos);
        yPos += 8;
        doc.text("Position: ___________________________", 20, yPos);
        
        // Add footer to all pages
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Page ${i} of ${pageCount}`, pageWidth - 30, pageHeight - 10);
            doc.text('Holy Family Church Hall Hire Agreement', 20, pageHeight - 10);
            doc.text('Generated: ' + new Date().toLocaleDateString('en-GB'), pageWidth / 2, pageHeight - 10, { align: 'center' });
        }
        
        // Save the PDF
        const fileName = `Holy_Family_Church_Hall_Hire_Agreement_${formData.fullName.replace(/\s+/g, '_')}_${formData.hireDate}.pdf`;
        doc.save(fileName);
        
        console.log('PDF generated successfully:', fileName);
        alert(`PDF generated successfully: ${fileName}\n\nPlease save this document and return it to the Parish Priest for final approval and signing.`);
    }
    
    // Form submission handler
    document.getElementById('agreementForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Basic validation
        const requiredFields = ['fullName', 'email', 'phone', 'address', 'postcode', 'hireDate', 'hireTimeFrom', 'hireTimeTo', 'purpose', 'attendees'];
        for (const field of requiredFields) {
            const element = document.getElementById(field);
            if (!element.value.trim()) {
                alert(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} field.`);
                element.focus();
                return;
            }
        }
        
        // Check purpose length
        const purpose = document.getElementById('purpose').value;
        if (purpose.length > 300) {
            alert('Purpose of hire must be 300 characters or less.');
            document.getElementById('purpose').focus();
            return;
        }
        
        // Checkbox validation
        if (!document.getElementById('ageConfirm').checked || !document.getElementById('termsConfirm').checked) {
            alert('Please confirm that you are over 18 and agree to the terms.');
            return;
        }
        
        // Check signature
        const signatureData = document.getElementById('signatureData').value;
        
        if (!signatureData || signatureData.trim() === '') {
            alert('Please provide your signature by signing in the box above and clicking "Confirm Signature".');
            document.getElementById('signatureCanvas').scrollIntoView({ behavior: 'smooth' });
            return;
        }
        
        if (!signatureConfirmed) {
            alert('Please click "Confirm Signature" button to save your signature.');
            return;
        }
        
        // Check if signature data is valid base64 image
        if (!signatureData.startsWith('data:image')) {
            alert('Signature appears to be invalid. Please clear and sign again.');
            return;
        }
        
        // Collect form data
        const formData = {
            fullName: document.getElementById('fullName').value,
            organization: document.getElementById('organization').value || '',
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            postcode: document.getElementById('postcode').value,
            hireDate: document.getElementById('hireDate').value,
            hireTimeFrom: document.getElementById('hireTimeFrom').value,
            hireTimeTo: document.getElementById('hireTimeTo').value,
            purpose: purpose,
            attendees: document.getElementById('attendees').value,
            signatureData: signatureData
        };
        
        console.log('Form data collected, generating PDF...');
        generatePDF(formData);
    });
    
    // Initialize total sections count
    document.getElementById('total-sections').textContent = totalSections;
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize purpose counter
        const purposeField = document.getElementById('purpose');
        const counter = document.getElementById('purpose-counter');
        if (purposeField && counter) {
            counter.textContent = `${purposeField.value.length}/300`;
        }
        
        // Set minimum date for hire date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('hireDate').min = today;
    });
</script>

</body>
</html>
